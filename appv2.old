import streamlit as st
import os
import tempfile
from langchain_community.document_loaders import PyPDFLoader
from backend.pipelines import main_evaluation_pipeline
from backend.evaluation import create_evaluation_chain
from backend.models import CustomLLM
from backend.rag import create_vector_store
from langchain_google_genai import ChatGoogleGenerativeAI
from backend.config import Config

# Configuraci√≥n de p√°gina
st.set_page_config(
    page_title="Evaluador Acad√©mico de Ensayos",
    page_icon="üìö",
    layout="wide",
    initial_sidebar_state="expanded"
)

st.markdown("""
    <style>
    /* Fondo principal personalizado */
    body, .main, .block-container {
        background-color: #F5F7F7 !important;
    }

    /* Header claro */
    [data-testid="stHeader"] {
        background-color: #F5F7F7 !important;
    }

    /* Sidebar profesional */
    section[data-testid="stSidebar"] {
        background: linear-gradient(180deg, #A6B8B8 0%, #DDEBF7 100%) !important;
        border-right: 2px solid #d4e7f0;
        padding: 1.5rem !important;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    section[data-testid="stSidebar"] * {
        color: #2c3e50 !important;
    }

    .main-header {
        font-size: 2.8rem;
        color: #1a5f7a;
        text-align: center;
        margin-bottom: 0.5rem;
        font-weight: 700;
        font-family: 'Georgia', serif;
    }
    .sub-header {
        font-size: 1.3rem;
        color: #2d8c9f;
        text-align: center;
        margin-bottom: 2rem;
        font-weight: 300;
        font-style: italic;
    }
    .section-header {
        font-size: 1.5rem;
        color: #1a5f7a;
        margin-top: 2rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid #e6f3f7;
        padding-bottom: 0.5rem;
        font-weight: 600;
        font-family: 'Georgia', serif;
    }

    .premium-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
        padding: 1.5rem;
        border-radius: 20px;
        border: 2px solid #e6f3f7;
        box-shadow: 0 8px 25px rgba(26, 95, 122, 0.1);
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        color: #2c3e50;
    }
    .premium-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(26, 95, 122, 0.15);
        border-color: #2d8c9f;
    }

    .metric-card {
        background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%);
        padding: 1.5rem;
        border-radius: 18px;
        border: 2px solid #d4e7f0;
        box-shadow: 0 6px 20px rgba(26, 95, 122, 0.08);
        margin-bottom: 1rem;
        text-align: center;
        transition: all 0.3s ease;
        color: #2c3e50;
    }
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(26, 95, 122, 0.12);
    }

    .stButton button {
        background: linear-gradient(135deg, #2d8c9f 0%, #1a5f7a 100%);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 0.7rem 2rem;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(45, 140, 159, 0.3);
    }
    .stButton button:hover {
        background: linear-gradient(135deg, #268191 0%, #15506b 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(45, 140, 159, 0.4);
    }

    .stTextArea textarea {
        border: 2px solid #d4e7f0;
        border-radius: 15px;
        padding: 1.2rem;
        font-size: 1rem;
        font-family: 'Arial', sans-serif;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
        color: #2c3e50 !important;
    }
    .stTextArea textarea:focus {
        border-color: #2d8c9f;
        box-shadow: 0 0 0 3px rgba(45, 140, 159, 0.1);
        color: #2c3e50 !important;
    }

    .stTextInput input, .stTextArea textarea, .stSelectbox select {
        color: #2c3e50 !important;
    }

    .streamlit-expanderContent {
        color: #2c3e50 !important;
    }

    .stProgress > div > div > div {
        background: linear-gradient(90deg, #2d8c9f 0%, #1a5f7a 100%);
        border-radius: 10px;
    }

    .streamlit-expanderHeader {
        background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
        border-radius: 12px;
        border: 2px solid #e6f3f7;
        font-weight: 600;
        color: #1a5f7a;
        font-family: 'Georgia', serif;
    }
    .streamlit-expanderHeader:hover {
        background: linear-gradient(135deg, #f8fbff 0%, #e6f3f7 100%);
    }

    .academic-badge {
        background: linear-gradient(135deg, #2d8c9f, #1a5f7a);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
        margin: 0.2rem;
    }

    p, div, span, h1, h2, h3, h4, h5, h6, li {
        color: #2c3e50 !important;
    }

    .evaluation-result {
        color: #2c3e50 !important;
        background-color: #f8fbff;
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid #e6f3f7;
        line-height: 1.6;
    }

    .stAlert {
        color: #2c3e50 !important;
    }

    /* User icon styling */
    .user-icon-container {
        text-align: center;
        margin: 1rem 0;
        padding: 1rem;
        background: rgba(255,255,255,0.7);
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    </style>
""", unsafe_allow_html=True)

# Header principal con dise√±o acad√©mico claro
st.markdown("""
    <div style='text-align: center; padding: 2rem 0; background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%); border-radius: 20px; margin-bottom: 2rem; border: 2px solid #e6f3f7;'>
        <h1 class="main-header">üìö Evaluador Acad√©mico de Ensayos</h1>
        <p class="sub-header">Herramienta profesional para la evaluaci√≥n objetiva de ensayos acad√©micos</p>
        <div style='margin-top: 1rem;'>
            <span class="academic-badge">üè´ Entorno Educativo</span>
            <span class="academic-badge">üìä Evaluaci√≥n Objetiva</span>
            <span class="academic-badge">üéØ Criterios Pedag√≥gicos</span>
        </div>
    </div>
""", unsafe_allow_html=True)

# Inicializaci√≥n de session state
if 'qa_chain' not in st.session_state:
    st.session_state.qa_chain = None
if 'retriever' not in st.session_state:
    st.session_state.retriever = None

qa_chain = st.session_state.qa_chain
retriever = st.session_state.retriever

# Sidebar profesional
with st.sidebar:
    st.markdown("""
        <div style='padding: 1rem; text-align: center;'>
            <h2 style='color: #1a5f7a; font-family: Georgia, serif; margin-bottom: 1rem;'>‚öôÔ∏è Panel del Docente</h2>
            <div style='background: linear-gradient(135deg, #ffffff, #f8fbff); padding: 1rem; border-radius: 15px; border: 2px solid #e6f3f7; margin: 1rem 0;'>
                <p style='color: #2d8c9f; font-size: 0.9rem;'>Configuraci√≥n acad√©mica para evaluaci√≥n de ensayos</p>
            </div>
        </div>
    """, unsafe_allow_html=True)

    # Icono dummy de usuario
    st.markdown("""
        <div class="user-icon-container">
            <img src='https://i.pinimg.com/736x/f6/bc/9a/f6bc9a75409c4db0acf3683bab1fab9c.jpg' alt='Usuario Dummy' style='border-radius: 50%; border: 3px solid #ffffff;'>
            <p style='color: #2c3e50; font-size: 0.9rem; margin-top: 0.5rem; font-weight: 500;'>Docente Invitado</p>
        </div>
    """, unsafe_allow_html=True)

    # Carga de r√∫brica personalizada
    uploaded_rubric = st.file_uploader(
        "üìÑ Cargar R√∫brica Personalizada (PDF)",
        type="pdf",
        help="Suba un archivo PDF con los criterios de evaluaci√≥n para usarlo en lugar de la r√∫brica predeterminada."
    )
    rubric_path = None
    if uploaded_rubric is not None:
        # Guardar archivo temporal
        with tempfile.NamedTemporaryFile(delete=False, suffix=".pdf") as tmp_file:
            tmp_file.write(uploaded_rubric.getvalue())
            rubric_path = tmp_file.name
        st.success("‚úÖ R√∫brica cargada exitosamente. Se usar√° para la evaluaci√≥n.")

    # Inicializaci√≥n del sistema
    if st.button("üîÑ Inicializar Sistema de Evaluaci√≥n", use_container_width=True):
        with st.spinner("üîÑ Inicializando componentes acad√©micos..."):
            try:
                progress_bar = st.progress(0)
                progress_text = st.empty()
                
                progress_text.text("Cargando r√∫bricas...")
                if uploaded_rubric is not None:
                    loader = PyPDFLoader(rubric_path)
                else:
                    loader = PyPDFLoader(Config.DRIVE_PATH)
                documents = loader.load()
                if not documents:
                    raise ValueError("No se pudieron cargar documentos de la r√∫brica")
                progress_bar.progress(20)
                
                progress_text.text("Creando vector store...")
                vector_store = create_vector_store(documents)
                retriever_temp = vector_store.as_retriever(search_kwargs={"k": Config.TOP_K_RETRIEVAL}) if vector_store else None
                progress_bar.progress(50)
                
                progress_text.text("Inicializando LLMs...")
                regressor_llm = CustomLLM(Config.MODEL_PATH)
                generative_llm = ChatGoogleGenerativeAI(
                    model=Config.GEMINI_MODEL,
                    temperature=0,
                    google_api_key=Config.GOOGLE_API_KEY
                )
                qa_chain_temp = create_evaluation_chain(regressor_llm, generative_llm, retriever_temp)
                progress_bar.progress(100)
                
                # Almacenar en session state
                st.session_state.qa_chain = qa_chain_temp
                st.session_state.retriever = retriever_temp
                
                qa_chain = st.session_state.qa_chain
                retriever = st.session_state.retriever
                
                st.success("""
                ‚úÖ **Sistema listo para evaluaci√≥n**
                \nModelos cargados correctamente para an√°lisis acad√©mico.
                """)
            except Exception as e:
                st.error(f"‚ùå Error en inicializaci√≥n: {str(e)}")
                st.info("üí° Verifique la configuraci√≥n de los modelos y el archivo PDF de r√∫bricas")
                st.session_state.qa_chain = None
                st.session_state.retriever = None
                qa_chain = None
                retriever = None

# Secci√≥n principal de entrada del ensayo
st.markdown("""
    <div class="premium-card">
        <div style='color: #1a5f7a;'>
            <h2 class="section-header">üìù Ingreso del Ensayo Acad√©mico</h2>
        </div>
        <p style='color: #2d8c9f; font-size: 1rem;'>Ingrese el ensayo para evaluaci√≥n seg√∫n criterios pedag√≥gicos establecidos</p>
    </div>
""", unsafe_allow_html=True)

# Layout mejorado para entrada
col1, col2 = st.columns([3, 1])
with col1:
    essay = st.text_area(
        "**Texto del ensayo:**",
        height=350,
        placeholder="""Ejemplo acad√©mico:

INTRODUCCI√ìN
El cambio clim√°tico representa uno de los desaf√≠os m√°s significativos de nuestro tiempo. Este ensayo examina sus causas fundamentales, impactos multidimensionales y las estrategias de mitigaci√≥n m√°s efectivas.

DESARROLLO
Las emisiones de gases de efecto invernadero, principalmente por actividades humanas, constituyen la principal causa...

CONCLUSI√ìN
En s√≠ntesis, la acci√≥n coordinada a nivel global es imperativa para enfrentar este desaf√≠o ambiental.""",
        key="essay_input",
        help="Recomendaci√≥n: 300-1000 palabras para una evaluaci√≥n √≥ptima"
    )

with col2:
    st.markdown("""
    <div class="premium-card">
        <div style='text-align: center; color: #1a5f7a; margin-bottom: 1rem;'>
            <h4>üéì Criterios de Evaluaci√≥n</h4>
        </div>
        <div style='background: #e6f3f7; padding: 1rem; border-radius: 12px;'>
            <p style='font-size: 0.9rem; color: #1a5f7a; margin: 0.5rem 0;'>‚úì <strong>Contenido:</strong> Profundidad y precisi√≥n</p>
            <p style='font-size: 0.9rem; color: #1a5f7a; margin: 0.5rem 0;'>‚úì <strong>Organizaci√≥n:</strong> Estructura l√≥gica</p>
            <p style='font-size: 0.9rem; color: #1a5f7a; margin: 0.5rem 0;'>‚úì <strong>Estilo:</strong> Claridad y formalidad</p>
            <p style='font-size: 0.9rem; color: #1a5f7a; margin: 0.5rem 0;'>‚úì <strong>Mec√°nica:</strong> Gram√°tica y ortograf√≠a</p>
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    # Estad√≠sticas en tiempo real
    if essay:
        word_count = len(essay.split())
        char_count = len(essay)
        paragraph_count = len([p for p in essay.split('\n\n') if p.strip()])
        
        st.markdown(f"""
        <div class="metric-card">
            <h4 style='color: #1a5f7a; margin-bottom: 1rem;'>üìä Estad√≠sticas</h4>
            <div style='display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;'>
                <div style='text-align: center;'>
                    <h5 style='color: #2d8c9f; margin: 0;'>{word_count}</h5>
                    <p style='font-size: 0.8rem; color: #1a5f7a; margin: 0;'>Palabras</p>
                </div>
                <div style='text-align: center;'>
                    <h5 style='color: #2d8c9f; margin: 0;'>{char_count}</h5>
                    <p style='font-size: 0.8rem; color: #1a5f7a; margin: 0;'>Caracteres</p>
                </div>
                <div style='text-align: center;'>
                    <h5 style='color: #2d8c9f; margin: 0;'>{paragraph_count}</h5>
                    <p style='font-size: 0.8rem; color: #1a5f7a; margin: 0;'>P√°rrafos</p>
                </div>
                <div style='text-align: center;'>
                    <h5 style='color: {'#27ae60' if 300 <= word_count <= 1000 else '#e67e22'}; margin: 0;'>
                        {'‚úÖ √ìptimo' if 300 <= word_count <= 1000 else '‚ö†Ô∏è Revisar'}
                    </h5>
                    <p style='font-size: 0.8rem; color: #1a5f7a; margin: 0;'>Longitud</p>
                </div>
            </div>
        </div>
        """, unsafe_allow_html=True)

# Bot√≥n de evaluaci√≥n
col1, col2, col3 = st.columns([1, 2, 1])
with col2:
    evaluate_btn = st.button("üéØ Iniciar Evaluaci√≥n Acad√©mica", type="primary", use_container_width=True)

if evaluate_btn:
    if not essay.strip():
        st.warning("""
        ‚ö†Ô∏è **Por favor, ingrese un ensayo para evaluar**
        \nEl campo de texto no puede estar vac√≠o.
        """)
    elif qa_chain is None:
        st.error("""
        ‚ùå **Sistema no inicializado**
        \nPor favor, inicialice el sistema desde el panel del docente primero.
        """)
    else:
        # Proceso de evaluaci√≥n
        with st.spinner("üîç Realizando an√°lisis acad√©mico..."):
            progress_bar = st.progress(0)
            status_text = st.empty()
            
            status_text.text("üìñ Analizando estructura del ensayo...")
            progress_bar.progress(30)
            
            status_text.text("üéì Aplicando criterios pedag√≥gicos...")
            progress_bar.progress(60)
            
            try:
                result = qa_chain.invoke({"essay": essay})
                progress_bar.progress(90)
                
                status_text.text("üìä Generando informe de evaluaci√≥n...")
                progress_bar.progress(100)
                
                st.balloons()
                st.success("‚úÖ Evaluaci√≥n acad√©mica completada exitosamente")
                
            except Exception as e:
                st.error(f"‚ùå Error durante la evaluaci√≥n: {str(e)}")
                st.stop()

        # SECCI√ìN DE RESULTADOS
        st.markdown("""
            <div class="premium-card">
                <div style='color: #1a5f7a;'>
                    <h2 class="section-header">üìä Resultados de la Evaluaci√≥n</h2>
                </div>
                <p style='color: #2d8c9f;'>An√°lisis completo basado en criterios acad√©micos establecidos</p>
            </div>
        """, unsafe_allow_html=True)
        
        # Puntuaciones en tarjetas (del app.txt original)
        score_rubrica = None
        score_modelo = None
        fortalezas = ""
        oportunidades = ""
        
        if "Puntuaci√≥n r√∫brica:" in result and "Puntuaci√≥n modelo:" in result:
            try:
                score_rubrica = result.split("Puntuaci√≥n r√∫brica: ")[1].split("/")[0].strip()
                score_modelo = result.split("Puntuaci√≥n modelo: ")[1].split("/")[0].strip()
                
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.markdown(f"""
                    <div class="metric-card">
                        <div style='color: #1a5f7a; margin-bottom: 1rem;'>
                            <h4>üìã R√∫brica Acad√©mica</h4>
                        </div>
                        <div style='font-size: 2.5rem; font-weight: bold; color: #1a5f7a; margin: 1rem 0;'>
                            {score_rubrica}<span style='font-size: 1rem; color: #2d8c9f;'>/6</span>
                        </div>
                        <p style='color: #2d8c9f; font-size: 0.9rem;'>Criterios pedag√≥gicos establecidos</p>
                    </div>
                    """, unsafe_allow_html=True)
                
                with col2:
                    st.markdown(f"""
                    <div class="metric-card">
                        <div style='color: #1a5f7a; margin-bottom: 1rem;'>
                            <h4>ü§ñ Evaluaci√≥n IA</h4>
                        </div>
                        <div style='font-size: 2.5rem; font-weight: bold; color: #1a5f7a; margin: 1rem 0;'>
                            {score_modelo}<span style='font-size: 1rem; color: #2d8c9f;'>/6</span>
                        </div>
                        <p style='color: #2d8c9f; font-size: 0.9rem;'>An√°lisis autom√°tico avanzado</p>
                    </div>
                    """, unsafe_allow_html=True)
                
                with col3:
                    diff = abs(int(score_rubrica) - int(score_modelo))
                    if diff <= 1:
                        consistency = "Alta"
                        color = "#27ae60"
                        icon = "‚úÖ"
                    elif diff <= 2:
                        consistency = "Media"
                        color = "#e67e22"
                        icon = "‚ö†Ô∏è"
                    else:
                        consistency = "Baja"
                        color = "#e74c3c"
                        icon = "üîç"
                    
                    st.markdown(f"""
                    <div class="metric-card">
                        <div style='color: #1a5f7a; margin-bottom: 1rem;'>
                            <h4>‚öñÔ∏è Consistencia</h4>
                        </div>
                        <div style='font-size: 2rem; font-weight: bold; color: {color}; margin: 1rem 0;'>
                            {icon} {consistency}
                        </div>
                        <p style='color: #2d8c9f; font-size: 0.9rem;'>Concordancia entre evaluaciones</p>
                    </div>
                    """, unsafe_allow_html=True)
                    
            except Exception as e:
                st.info("""
                üìù **Evaluaci√≥n cualitativa generada**
                \nRevise el an√°lisis detallado para informaci√≥n completa sobre el ensayo.
                """)
        
        # Parsear fortalezas y oportunidades del resultado del modelo
        # Asumiendo que el modelo genera secciones como "Fortalezas:" y "Oportunidades de Mejora:"
        if "Fortalezas:" in result:
            try:
                fortalezas_start = result.find("Fortalezas:") + len("Fortalezas:")
                oportunidades_start = result.find("Oportunidades:", fortalezas_start)
                if oportunidades_start != -1:
                    fortalezas = result[fortalezas_start:oportunidades_start].strip()
                else:
                    fortalezas = result[fortalezas_start:].strip()
            except:
                fortalezas = "Fortalezas identificadas en el an√°lisis del modelo."
        
        if "Oportunidades de Mejora:" in result:
            try:
                oportunidades_start = result.find("Oportunidades de Mejora:") + len("Oportunidades de Mejora:")
                oportunidades = result[oportunidades_start:].strip().split("\n\n")[0]  # Tomar hasta la siguiente secci√≥n
            except:
                oportunidades = "Oportunidades de mejora sugeridas por el modelo."
        
        # RECOMENDACIONES PEDAG√ìGICAS (din√°micas, antes del an√°lisis detallado)
        st.markdown("""
            <div class="premium-card">
                <div style='color: #1a5f7a;'>
                    <h2 class="section-header">üí° Recomendaciones Pedag√≥gicas</h2>
                </div>
                <p style='color: #2d8c9f;'>Orientaciones para la mejora del proceso de escritura acad√©mica</p>
            </div>
        """, unsafe_allow_html=True)
        
        rec_col1, rec_col2 = st.columns(2)
        
        with rec_col1:
            st.markdown(f"""
            <div class="premium-card">
                <h4 style='color: #1a5f7a; margin-bottom: 1rem;'>üéØ Aspectos Destacados</h4>
                <div style='background: #e6f3f7; padding: 1rem; border-radius: 12px;'>
                    <p style='color: #1a5f7a; margin: 0.8rem 0;'>{fortalezas}</p>
                </div>
            </div>
            """, unsafe_allow_html=True)
        
        with rec_col2:
            st.markdown(f"""
            <div class="premium-card">
                <h4 style='color: #1a5f7a; margin-bottom: 1rem;'>üìà Oportunidades de Mejora</h4>
                <div style='background: #fff8e1; padding: 1rem; border-radius: 12px;'>
                    <p style='color: #1a5f7a; margin: 0.8rem 0;'>{oportunidades}</p>
                </div>
            </div>
            """, unsafe_allow_html=True)

        # An√°lisis detallado (despu√©s de las recomendaciones)
        with st.expander("üîç **An√°lisis Pedag√≥gico Detallado**", expanded=True):
            st.markdown("""
                <div class="evaluation-result">
                    <h4 style='color: #1a5f7a; margin-bottom: 1rem;'>Evaluaci√≥n Completa del Ensayo</h4>
            """, unsafe_allow_html=True)
            st.markdown(result)
            st.markdown("</div>", unsafe_allow_html=True)

# Limpiar archivo temporal si existe
if 'rubric_path' in locals() and rubric_path and os.path.exists(rubric_path):
    try:
        os.unlink(rubric_path)
    except:
        pass

# Pie de p√°gina
st.markdown("---")
st.markdown("""
    <div style='text-align: center; padding: 2rem; background: linear-gradient(135deg, #ffffff, #f8fbff); border-radius: 15px; border: 2px solid #e6f3f7;'>
        <div style='display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;'>
            <div style='text-align: left;'>
                <h4 style='color: #1a5f7a; margin: 0;'>üè´ Evaluador Acad√©mico</h4>
                <p style='color: #2d8c9f; font-size: 0.9rem; margin: 0.5rem 0;'>Herramienta profesional para docentes</p>
            </div>
            <div style='text-align: center;'>
                <p style='color: #1a5f7a; margin: 0;'><strong>üõ†Ô∏è Plataforma Educativa</strong></p>
                <p style='color: #2d8c9f; font-size: 0.9rem; margin: 0;'>Streamlit ‚Ä¢ LangChain ‚Ä¢ Transformers</p>
            </div>
            <div style='text-align: right;'>
                <p style='color: #1a5f7a; margin: 0;'><strong>üìö Versi√≥n Acad√©mica 2.1</strong></p>
                <p style='color: #2d8c9f; font-size: 0.9rem; margin: 0;'>Noviembre 2025</p>
            </div>
        </div>
    </div>
""", unsafe_allow_html=True)